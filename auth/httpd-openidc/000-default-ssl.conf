<VirtualHost *:80>
    ServerName ${SERVER_NAME}
    Redirect permanent / ${MAIN_URL}
</VirtualHost>

<VirtualHost *:8443>
	ErrorDocument 404 'Due to the nature of OIDCProviderMetadataURL this setup must sit at <a href="http://openidc">http://openidc</a>, presumably an /etc/hosts entry'
	DocumentRoot htdocs/nonexistent/
</VirtualHost>

<VirtualHost *:8443>
    ServerName ${AUTH_SERVER_NAME}
	ServerAdmin webmaster@localhost

	ErrorLog /proc/self/fd/1
	CustomLog /proc/self/fd/2 combined
	LogLevel debug

	RequestHeader set X-Forwarded-Proto "https" early
	RequestHeader set X-Forwarded-SSL "on"
	RequestHeader set X-Forwarded-Port 8443

	SSLProxyEngine on
	#
	# These are for SSL Certificates without good pedigree CAs
	# - ie TESTING ONLY
	#
	SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

	ProxyPreserveHost On

	ProxyPass / https://keycloak:8443/
</VirtualHost>

<VirtualHost *:8443>
    ServerName ${SERVER_NAME}
	ServerAdmin webmaster@localhost
	DocumentRoot htdocs/

	ErrorLog /proc/self/fd/1
	CustomLog /proc/self/fd/2 combined
	LogLevel debug

	Header set OIDC_access_token "%{OIDC_access_token}e" env=OIDC_access_token

	RequestHeader set X-Forwarded-Proto "https" early
	RequestHeader set X-Forwarded-SSL "on"
	RequestHeader set X-Forwarded-Port 8443

	SSLProxyEngine on
	#
	# These are for SSL Certificates without good pedigree CAs
	# - ie TESTING ONLY
	#
	SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

	ProxyPreserveHost On

	OIDCProviderMetadataURL ${OIDC_OPENID_CONFIGURATION}
	OIDCSSLValidateServer ${OIDC_VALIDATE_CERTIFICATE}
	OIDCRedirectURI ${OIDC_REDIRECT_URI}
	OIDCDefaultURL ${OIDC_DEFAULT_URL}
	OIDCCryptoPassphrase ${OIDC_CRYPTO_PASSPHRASE}
	OIDCClientID ${OIDC_CLIENT}
	OIDCClientSecret ${OIDC_CLIENT_SECRET}
	OIDCScope "openid email profile"
	OIDCXForwardedHeaders X-Forwarded-Host X-Forwarded-Port X-Forwarded-Proto
	OIDCPassClaimsAs headers

	OIDCRemoteUserClaim sub
	OIDCPassClaimsAs environment

	OIDCInfoHook userinfo

	# See fast if we accumulate state cookies
	LimitRequestFieldSize 4096

	Header setifempty Cache-Control "max-age=0, must-revalidate"

	RedirectTemp /logout https://${SERVER_NAME}:8443/redirect_uri?logout=https%3A%2F%2F${SERVER_NAME}%3A8443%2F

	<Location "/">
		AuthType openid-connect
		Require valid-user
	</Location>

	ProxyPass "/api/"  "http://host.docker.internal:3000/api/"
	#ProxyPassReverse "/api/"  "http://host.docker.internal:3000/api/"
	<Location "/api/">
		AuthType openid-connect
		Require valid-user
	</Location>
</VirtualHost>
