<VirtualHost *:80>
    ServerName localhost
	ServerAdmin webmaster@localhost

	ErrorLog /proc/self/fd/1
	CustomLog /proc/self/fd/2 combined
	LogLevel debug

	Header set OIDC_access_token "%{OIDC_access_token}e" env=OIDC_access_token
	Header set OIDC_access_token_expires "%{OIDC_access_token_expires}e" env=OIDC_access_token_expires

	RequestHeader set X-Forwarded-Proto "http" early
	RequestHeader set X-Forwarded-Port 8078

	ProxyPreserveHost On

	OIDCProviderMetadataURL ${OIDC_OPENID_CONFIGURATION}
	OIDCSSLValidateServer ${OIDC_VALIDATE_CERTIFICATE}
	OIDCRedirectURI ${OIDC_REDIRECT_URI}
	OIDCDefaultURL ${OIDC_DEFAULT_URL}
	OIDCCryptoPassphrase ${OIDC_CRYPTO_PASSPHRASE}
	OIDCClientID ${OIDC_CLIENT}
	OIDCClientSecret ${OIDC_CLIENT_SECRET}
	OIDCScope "openid email profile"
	OIDCXForwardedHeaders X-Forwarded-Host X-Forwarded-Port X-Forwarded-Proto
	OIDCPassClaimsAs headers

	OIDCRemoteUserClaim sub
	OIDCPassClaimsAs environment

	OIDCInfoHook userinfo

	# See fast if we accumulate state cookies
	LimitRequestFieldSize 4096

	Header setifempty Cache-Control "max-age=0, must-revalidate"

	RedirectTemp /logout ${OIDC_REDIRECT_URI}?logout=${OIDC_DEFAULT_URL}

	<Location ${API_SERVICE_ENDPOINT}>
		ProxyPass ${API_SERVICE_URL}
		ProxyPassReverse ${API_SERVICE_URL}

		AuthType openid-connect
		Require valid-user
	</Location>

	<Location /silent-check-sso.html>
		AuthType openid-connect
		Require valid-user
	</Location>

	<Location ${CLIENT_SERVICE_ENDPOINT}>
		ProxyPass ${CLIENT_SERVICE_URL}
		ProxyPassReverse ${CLIENT_SERVICE_URL}
		
		AuthType openid-connect
		Require valid-user
	</Location>
</VirtualHost>
